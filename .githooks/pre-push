#!/bin/sh

echo "ğŸ” Running pre-push checks..."

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®@pre-pushãƒã‚§ãƒƒã‚¯
echo "ğŸ“ Checking @pre-push tag..."
commit_message=$(git log -1 --pretty=%B)
if ! echo "$commit_message" | grep -q "@pre-push"; then
    echo "âŒ Error: Commit message must include @pre-push tag"
    exit 1
fi
echo "âœ… @pre-push tag check passed"

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—
changed_files=$(git diff --cached --name-only)

# TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
ts_files=$(echo "$changed_files" | grep -E "\.tsx?$" || true)
if [ -n "$ts_files" ]; then
    echo "ğŸ” Checking TypeScript files..."
    
    # TypeScriptã®ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
    echo "ğŸ—ï¸ Building TypeScript..."
    if ! deno check **/*.ts; then
        echo "âŒ TypeScript build failed"
        exit 1
    fi
    
    # Lintãƒã‚§ãƒƒã‚¯
    echo "ğŸ§¹ Running linter..."
    if ! deno lint; then
        echo "âŒ Lint check failed"
        exit 1
    fi
    
    echo "âœ… TypeScript checks passed"
fi

# JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
json_files=$(echo "$changed_files" | grep -E "\.json$" || true)
if [ -n "$json_files" ]; then
    echo "ğŸ” Checking JSON files..."
    for file in $json_files; do
        if ! deno fmt --check "$file"; then
            echo "âŒ JSON format check failed for $file"
            exit 1
        fi
    done
    echo "âœ… JSON checks passed"
fi

# Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
md_files=$(echo "$changed_files" | grep -E "\.md$" || true)
if [ -n "$md_files" ]; then
    echo "ğŸ” Checking Markdown files..."
    if ! deno fmt --check; then
        echo "âŒ Markdown format check failed"
        exit 1
    fi
    echo "âœ… Markdown checks passed"
fi

# ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
other_files=$(echo "$changed_files" | grep -vE "\.(tsx?|json|md)$" || true)
if [ -n "$other_files" ]; then
    echo "ğŸ” Checking other files..."
    # ã“ã“ã«å¿…è¦ãªãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆä¾‹ï¼šCSSã®lintãªã©ï¼‰
    echo "âœ… Other file checks passed"
fi

echo "âœ… All checks passed! Ready to push."
exit 0 